<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Inner Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Source+Serif+4:opsz,wght@8..60,600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; color: #333; line-height: 1.6; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .date-container { width: 100%; max-width: 900px; margin-bottom: 20px; text-align: center; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 30, 80, 0.05); }
        header { text-align: center; width: 100%; max-width: 900px; margin-bottom: 40px; border-bottom: 1px solid #dde3e8; padding-bottom: 20px; }
        header h1 { font-family: 'Source Serif 4', serif; font-weight: 600; color: #1a2533; font-size: 2.5rem; margin: 0; }
        main { width: 100%; max-width: 900px; margin: 0 auto; }
        .module { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 30, 80, 0.05); padding: 25px; margin-bottom: 30px; }
        .module h2 { font-family: 'Inter', sans-serif; font-weight: 600; color: #005f73; margin-top: 0; border-bottom: 2px solid #e0f7fa; padding-bottom: 10px; }
        .brief-container h3 { font-size: 1.4rem; color: #0a2d4d; margin-bottom: 10px; }
        #research-paper-content h4 { color: #005f73; font-weight: 600; border-bottom: 1px solid #e0f7fa; padding-bottom: 5px; margin-top: 20px; }
        .flashcard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .flashcard { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; cursor: pointer; perspective: 1000px; }
        .flashcard.is-flipped .card-inner { transform: rotateY(180deg); }
        .flashcard .card-inner { position: relative; width: 100%; min-height: 120px; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .card-front h3 { margin: 0; font-size: 1.2rem; color: #0077b6; }
        .card-back { transform: rotateY(180deg); font-size: 0.9rem; padding: 5px; }
        #journal-entry { width: 100%; box-sizing: border-box; min-height: 150px; padding: 10px; border-radius: 6px; border: 1px solid #dde3e8; font-family: 'Inter', sans-serif; font-size: 1rem; resize: vertical; }
        #save-journal-btn { background-color: #0077b6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background-color 0.2s; margin-top: 10px; }
        #save-journal-btn:hover:not(:disabled) { background-color: #005f73; }
        #save-journal-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
    </style>
</head>
<body>
    <header><h1>The Inner Lab Method</h1></header>
    
    <div class="date-container">
        <label for="date-selector">Select a Day:</label>
        <input type="date" id="date-selector" disabled>
    </div>

    <main id="main-content" style="display:none;">
        <section class="module" id="research-module">
            <h2>Research Paper of the Day</h2>
            <div class="brief-container">
                <h3 id="brief-title"></h3>
                <div id="research-paper-content"></div>
                <small id="brief-source"></small>
            </div>
        </section>
        <section class="module" id="concepts-module">
            <h2>Core Concepts</h2>
            <div class="flashcard-grid" id="flashcard-grid"></div>
        </section>
        <section class="module" id="journal-module">
            <h2>Synthesis Journal</h2>
            <p>Synthesize today's topics. What connections can you make? How can you apply this?</p>
            <textarea id="journal-entry" placeholder="Your thoughts..."></textarea>
            <button id="save-journal-btn">Save Journal</button>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- Your Web App's Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDeT_BSciMftq2Rx7Gzk63oP-DgNNslXME",
            authDomain: "innerlabresearch.firebaseapp.com",
            projectId: "innerlabresearch",
            storageBucket: "innerlabresearch.firebasestorage.app",
            messagingSenderId: "137996904547",
            appId: "1:137996904547:web:9a1b86dc9aa41237fcb056",
            measurementId: "G-VGVRLJSWPZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let currentDateString = null;

        const dateSelector = document.getElementById('date-selector');
        const mainContent = document.getElementById('main-content');
        const saveJournalBtn = document.getElementById('save-journal-btn');

        // 1. Handle User Authentication
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User is signed in with UID:", user.uid);
                currentUserId = user.uid;
                initializeAppUI();
            } else {
                console.log("No user signed in, attempting anonymous sign-in...");
                signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
            }
        });

        // 2. Set up the UI once we have a user
        function initializeAppUI() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            dateSelector.value = todayString;
            dateSelector.disabled = false;
            currentDateString = todayString;
            
            loadDataForDate(currentDateString);

            dateSelector.addEventListener('change', () => {
                currentDateString = dateSelector.value;
                loadDataForDate(currentDateString);
            });
            saveJournalBtn.addEventListener('click', saveJournal);
        }

        // 3. Main logic to call your Cloud Function
        async function loadDataForDate(dateString) {
            if (!currentUserId) {
                console.log("Waiting for user to be authenticated...");
                return;
            }
            showLoadingState();
            const getAndGenerateContent = httpsCallable(functions, 'getAndGenerateContent');
            
            try {
                const result = await getAndGenerateContent({ dateString: dateString, userId: currentUserId });
                displayAllData(result.data);
                mainContent.style.display = 'block';
            } catch (error) {
                console.error("Error fetching or generating data via Cloud Function:", error);
                showErrorState(error.message);
            }
        }

        // 4. Logic to save the journal entry to the database
        async function saveJournal() {
            if (!currentUserId || !currentDateString) return;
            
            const journalText = document.getElementById('journal-entry').value;
            saveJournalBtn.disabled = true;
            saveJournalBtn.textContent = 'Saving...';

            const docRef = doc(db, "users", currentUserId, "dailyEntries", currentDateString);
            
            try {
                await setDoc(docRef, { journal: journalText }, { merge: true });
                saveJournalBtn.textContent = 'Saved!';
            } catch (error) {
                console.error("Error saving journal:", error);
                saveJournalBtn.textContent = 'Error - Retry';
            } finally {
                setTimeout(() => {
                    saveJournalBtn.textContent = 'Save Journal';
                    saveJournalBtn.disabled = false;
                }, 2000);
            }
        }

        // --- UI Helper Functions ---
        function displayAllData(data) {
            displayResearch(data.research);
            displayConcepts(data.concepts);
            displayJournal(data.journal);
        }

        function showLoadingState() {
            mainContent.style.display = 'block';
            document.getElementById('brief-title').textContent = "Loading...";
            document.getElementById('research-paper-content').innerHTML = "<p>Please wait while your content is generated...</p>";
            document.getElementById('brief-source').textContent = "";
            document.getElementById('flashcard-grid').innerHTML = "<p>Loading...</p>";
            document.getElementById('journal-entry').value = "";
        }
        
        function showErrorState(message) {
             document.getElementById('brief-title').textContent = "An Error Occurred";
             document.getElementById('research-paper-content').innerHTML = `<p>Details: ${message}</p>`;
             document.getElementById('flashcard-grid').innerHTML = "";
        }

        function displayResearch(research) {
            if (!research) { showErrorState("Could not load research paper."); return; }
            document.getElementById('brief-title').textContent = research.title;
            const contentEl = document.getElementById('research-paper-content');
            const formatContent = (text) => (text || '').replace(/\n/g, '</p><p>');
            contentEl.innerHTML = `<h4>Introduction</h4><p>${formatContent(research.introduction)}</p><h4>Key Findings</h4><p>${formatContent(research.keyFindings)}</p><h4>Conclusion</h4><p>${formatContent(research.conclusion)}</p>`;
            document.getElementById('brief-source').textContent = `Source: ${research.source || 'N/A'}`;
        }

        function displayConcepts(concepts) {
            const grid = document.getElementById('flashcard-grid');
            grid.innerHTML = "";
            if (concepts && concepts.length > 0) {
                concepts.forEach(concept => {
                    const card = document.createElement('div');
                    card.className = 'flashcard';
                    card.innerHTML = `<div class="card-inner"><div class="card-face card-front"><h3>${concept.term}</h3></div><div class="card-face card-back"><p>${concept.definition}</p></div></div>`;
                    card.addEventListener('click', () => card.classList.toggle('is-flipped'));
                    grid.appendChild(card);
                });
            } else {
                grid.innerHTML = "<p>No concepts could be loaded.</p>";
            }
        }

        function displayJournal(journalText) {
            document.getElementById('journal-entry').value = journalText || '';
        }

    </script>
</body>
</html>

