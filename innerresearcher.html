<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Inner Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Source+Serif+4:opsz,wght@8..60,600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; color: #333; line-height: 1.6; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .date-container { width: 100%; max-width: 900px; margin-bottom: 20px; text-align: center; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 30, 80, 0.05); }
        header { text-align: center; width: 100%; max-width: 900px; margin-bottom: 40px; border-bottom: 1px solid #dde3e8; padding-bottom: 20px; }
        header h1 { font-family: 'Source Serif 4', serif; font-weight: 600; color: #1a2533; font-size: 2.5rem; margin: 0; }
        main { width: 100%; max-width: 900px; margin: 0 auto; }
        .module { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 30, 80, 0.05); padding: 25px; margin-bottom: 30px; }
        .module h2 { font-family: 'Inter', sans-serif; font-weight: 600; color: #005f73; margin-top: 0; border-bottom: 2px solid #e0f7fa; padding-bottom: 10px; }
        .brief-container h3 { font-size: 1.4rem; color: #0a2d4d; margin-bottom: 10px; }
        #research-paper-content h4 { color: #005f73; font-weight: 600; border-bottom: 1px solid #e0f7fa; padding-bottom: 5px; margin-top: 20px; }
        #research-paper-content p { margin: 10px 0; }
        .flashcard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .flashcard { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; cursor: pointer; perspective: 1000px; min-height: 150px; }
        .flashcard.is-flipped .card-inner { transform: rotateY(180deg); }
        .flashcard .card-inner { position: relative; width: 100%; min-height: 120px; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 10px; box-sizing: border-box; }
        .card-front h3 { margin: 0; font-size: 1.2rem; color: #0077b6; }
        .card-back { transform: rotateY(180deg); font-size: 0.9rem; }
        #journal-entry { width: 100%; box-sizing: border-box; min-height: 150px; padding: 10px; border-radius: 6px; border: 1px solid #dde3e8; font-family: 'Inter', sans-serif; font-size: 1rem; resize: vertical; }
        #save-journal-btn { background-color: #0077b6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background-color 0.2s; margin-top: 10px; }
        #save-journal-btn:hover:not(:disabled) { background-color: #005f73; }
        #save-journal-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background-color: #f8d7da; color: #721c24; padding: 20px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <header><h1>The Inner Lab Method</h1></header>
    
    <div class="date-container">
        <label for="date-selector">Select a Day:</label>
        <input type="date" id="date-selector" disabled>
    </div>

    <main id="main-content" style="display:none;">
        <section class="module" id="research-module">
            <h2>Research Paper of the Day</h2>
            <div class="brief-container">
                <h3 id="brief-title">Loading...</h3>
                <div id="research-paper-content"><p class="loading">Generating your personalized content...</p></div>
                <small id="brief-source"></small>
            </div>
        </section>
        
        <section class="module" id="concepts-module">
            <h2>Core Concepts</h2>
            <div class="flashcard-grid" id="flashcard-grid">
                <p class="loading">Loading concepts...</p>
            </div>
        </section>
        
        <section class="module" id="journal-module">
            <h2>Synthesis Journal</h2>
            <p>Synthesize today's topics. What connections can you make? How can you apply this?</p>
            <textarea id="journal-entry" placeholder="Your thoughts..."></textarea>
            <button id="save-journal-btn">Save Journal</button>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDeT_BSciMftq2Rx7Gzk63oP-DgNNslXME",
            authDomain: "innerlabresearch.firebaseapp.com",
            projectId: "innerlabresearch",
            storageBucket: "innerlabresearch.appspot.com", // Corrected URL
            messagingSenderId: "137996904547",
            appId: "1:137996904547:web:9a1b86dc9aa41237fcb056",
            measurementId: "G-VGVRLJSWPZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Vercel API endpoint
        const VERCEL_API_URL = 'https://blog-sable-two-13.vercel.app/api/generate';

        let currentUserId = null;
        let currentDateString = null;

        const dateSelector = document.getElementById('date-selector');
        const mainContent = document.getElementById('main-content');
        const saveJournalBtn = document.getElementById('save-journal-btn');
        const journalEntry = document.getElementById('journal-entry');

        // Handle User Authentication
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User signed in:", user.uid);
                currentUserId = user.uid;
                initializeAppUI();
            } else {
                console.log("Signing in anonymously...");
                signInAnonymously(auth).catch(error => {
                    console.error("Sign-in failed:", error);
                    showError("Authentication failed. Please refresh the page.");
                });
            }
        });

        function initializeAppUI() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            dateSelector.value = todayString;
            dateSelector.max = todayString;
            dateSelector.disabled = false;
            currentDateString = todayString;
            
            loadDataForDate(currentDateString);

            dateSelector.addEventListener('change', () => {
                currentDateString = dateSelector.value;
                loadDataForDate(currentDateString);
            });

            saveJournalBtn.addEventListener('click', saveJournal);
        }

        async function loadDataForDate(dateString) {
            if (!currentUserId) {
                console.log("Waiting for authentication...");
                return;
            }

            showLoadingState();
            mainContent.style.display = 'block';

            try {
                // First, check if we have this data in Firestore
                const docRef = doc(db, "users", currentUserId, "dailyEntries", dateString);
                const docSnap = await getDoc(docRef);

                let data;

                if (docSnap.exists()) {
                    console.log("Loading cached content from Firestore");
                    data = docSnap.data();
                } else {
                    console.log("Generating new content from Vercel API");
                    // Call Vercel API to generate new content
                    const response = await fetch(VERCEL_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        // CRITICAL FIX: Send userId to the backend
                        body: JSON.stringify({ date: dateString, userId: currentUserId })
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(errorBody.details || `API error: ${response.status}`);
                    }

                    data = await response.json();

                    // Save to Firestore for future visits
                    await setDoc(docRef, {
                        research: data.research,
                        concepts: data.concepts,
                        journal: "",
                        createdAt: new Date().toISOString()
                    });
                }

                displayContent(data);
                
            } catch (error) {
                console.error("Error loading content:", error);
                showError(error.message);
            }
        }

        function displayContent(data) {
            displayResearch(data.research);
            displayConcepts(data.concepts);
            displayJournal(data.journal || "");
        }

        function displayResearch(research) {
            document.getElementById('brief-title').textContent = research.title;
            const contentEl = document.getElementById('research-paper-content');
            contentEl.innerHTML = `
                <h4>Introduction</h4>
                <p>${research.introduction}</p>
                <h4>Key Findings</h4>
                <p>${research.keyFindings}</p>
                <h4>Conclusion</h4>
                <p>${research.conclusion}</p>
            `;
            document.getElementById('brief-source').textContent = `Source: ${research.source}`;
        }

        function displayConcepts(concepts) {
            const grid = document.getElementById('flashcard-grid');
            grid.innerHTML = '';
            
            if (concepts && concepts.length > 0) {
                concepts.forEach(concept => {
                    const card = document.createElement('div');
                    card.className = 'flashcard';
                    card.innerHTML = `
                        <div class="card-inner">
                            <div class="card-face card-front">
                                <h3>${concept.term}</h3>
                            </div>
                            <div class="card-face card-back">
                                <p>${concept.definition}</p>
                            </div>
                        </div>
                    `;
                    card.addEventListener('click', () => card.classList.toggle('is-flipped'));
                    grid.appendChild(card);
                });
            } else {
                grid.innerHTML = '<p>No concepts available.</p>';
            }
        }

        function displayJournal(journalText) {
            journalEntry.value = journalText;
        }

        async function saveJournal() {
            if (!currentUserId || !currentDateString) return;
            
            const journalText = journalEntry.value;
            saveJournalBtn.disabled = true;
            saveJournalBtn.textContent = 'Saving...';

            const docRef = doc(db, "users", currentUserId, "dailyEntries", currentDateString);
            
            try {
                await setDoc(docRef, { journal: journalText }, { merge: true });
                saveJournalBtn.textContent = 'Saved!';
                console.log("Journal saved to Firestore");
            } catch (error) {
                console.error("Error saving journal:", error);
                saveJournalBtn.textContent = 'Error - Retry';
            } finally {
                setTimeout(() => {
                    saveJournalBtn.textContent = 'Save Journal';
                    saveJournalBtn.disabled = false;
                }, 2000);
            }
        }

        function showLoadingState() {
            document.getElementById('brief-title').textContent = 'Generating...';
            document.getElementById('research-paper-content').innerHTML = '<p class="loading">Creating your personalized research paper...</p>';
            document.getElementById('brief-source').textContent = '';
            document.getElementById('flashcard-grid').innerHTML = '<p class="loading">Preparing core concepts...</p>';
            journalEntry.value = '';
        }

        function showError(message) {
            const errorHtml = `<div class="error"><strong>Error:</strong> ${message}<br><small>Try refreshing the page or check the console for details.</small></div>`;
            document.getElementById('research-paper-content').innerHTML = errorHtml;
            document.getElementById('flashcard-grid').innerHTML = '';
        }
    </script>
</body>
</html>
```

#### **Step 2: Update Your Firebase Security Rules**

**Action:** Go to your Firebase project's **Firestore Database > Rules** tab, delete everything, and replace it with these final rules. Then click **Publish**.

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // This rule allows any authenticated user (including the anonymous
    // users your app creates) to read and write ONLY to their own
    // private documents within the 'users' collection.
    match /users/{userId}/dailyEntries/{entry} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}

