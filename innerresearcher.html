<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Inner Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Source+Serif+4:opsz,wght@8..60,600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; color: #333; line-height: 1.6; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .date-container { width: 100%; max-width: 900px; margin-bottom: 20px; text-align: center; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 30, 80, 0.05); }
        header { text-align: center; width: 100%; max-width: 900px; margin-bottom: 40px; border-bottom: 1px solid #dde3e8; padding-bottom: 20px; }
        header h1 { font-family: 'Source Serif 4', serif; font-weight: 600; color: #1a2533; font-size: 2.5rem; margin: 0; }
        main { width: 100%; max-width: 900px; margin: 0 auto; }
        .module { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 30, 80, 0.05); padding: 25px; margin-bottom: 30px; }
        .module h2 { font-family: 'Inter', sans-serif; font-weight: 600; color: #005f73; margin-top: 0; border-bottom: 2px solid #e0f7fa; padding-bottom: 10px; }
        .brief-container h3 { font-size: 1.4rem; color: #0a2d4d; margin-bottom: 10px; }
        #research-paper-content h4 { color: #005f73; font-weight: 600; border-bottom: 1px solid #e0f7fa; padding-bottom: 5px; margin-top: 20px; }
        #research-paper-content p { margin: 10px 0; }
        .flashcard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .flashcard { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; cursor: pointer; perspective: 1000px; min-height: 150px; }
        .flashcard.is-flipped .card-inner { transform: rotateY(180deg); }
        .flashcard .card-inner { position: relative; width: 100%; min-height: 120px; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 10px; box-sizing: border-box; }
        .card-front h3 { margin: 0; font-size: 1.2rem; color: #0077b6; }
        .card-back { transform: rotateY(180deg); font-size: 0.9rem; }
        #journal-entry { width: 100%; box-sizing: border-box; min-height: 150px; padding: 10px; border-radius: 6px; border: 1px solid #dde3e8; font-family: 'Inter', sans-serif; font-size: 1rem; resize: vertical; }
        #save-journal-btn { background-color: #0077b6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background-color 0.2s; margin-top: 10px; }
        #save-journal-btn:hover:not(:disabled) { background-color: #005f73; }
        #save-journal-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background-color: #f8d7da; color: #721c24; padding: 20px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <header><h1>The Inner Lab Method</h1></header>
    
    <div class="date-container">
        <label for="date-selector">Select a Day:</label>
        <input type="date" id="date-selector">
    </div>

    <main id="main-content">
        <section class="module" id="research-module">
            <h2>Research Paper of the Day</h2>
            <div class="brief-container">
                <h3 id="brief-title">Loading...</h3>
                <div id="research-paper-content"><p class="loading">Generating your personalized content...</p></div>
                <small id="brief-source"></small>
            </div>
        </section>
        
        <section class="module" id="concepts-module">
            <h2>Core Concepts</h2>
            <div class="flashcard-grid" id="flashcard-grid">
                <p class="loading">Loading concepts...</p>
            </div>
        </section>
        
        <section class="module" id="journal-module">
            <h2>Synthesis Journal</h2>
            <p>Synthesize today's topics. What connections can you make? How can you apply this?</p>
            <textarea id="journal-entry" placeholder="Your thoughts..."></textarea>
            <button id="save-journal-btn">Save Journal</button>
            <small id="journal-status" style="display: block; margin-top: 10px; color: #666;"></small>
        </section>
    </main>

    <script>
        const dateSelector = document.getElementById('date-selector');
        const saveJournalBtn = document.getElementById('save-journal-btn');
        const journalEntry = document.getElementById('journal-entry');
        const journalStatus = document.getElementById('journal-status');

        // Initialize with today's date
        const today = new Date();
        const todayString = today.toISOString().split('T')[0];
        dateSelector.value = todayString;
        dateSelector.max = todayString; // Can't select future dates

        let currentDate = todayString;

        // Load content when date changes
        dateSelector.addEventListener('change', () => {
            currentDate = dateSelector.value;
            loadContentForDate(currentDate);
        });

        // Save journal button
        saveJournalBtn.addEventListener('click', saveJournal);

        // Load initial content
        loadContentForDate(currentDate);

        async function loadContentForDate(dateString) {
            // Check if we have cached content for this date
            const cached = getFromCache(dateString);
            
            if (cached) {
                displayContent(cached);
                return;
            }

            // Show loading state
            showLoading();

            try {
                // Call our Vercel serverless function
                // Use relative path since this file is innerresearcher.html
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: dateString })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                
                // Cache the content
                saveToCache(dateString, data);
                
                // Display it
                displayContent(data);
                
            } catch (error) {
                console.error('Error loading content:', error);
                showError(error.message);
            }
        }

        function displayContent(data) {
            displayResearch(data.research);
            displayConcepts(data.concepts);
            loadJournal(currentDate);
        }

        function displayResearch(research) {
            document.getElementById('brief-title').textContent = research.title;
            
            const contentEl = document.getElementById('research-paper-content');
            contentEl.innerHTML = `
                <h4>Introduction</h4>
                <p>${research.introduction}</p>
                <h4>Key Findings</h4>
                <p>${research.keyFindings}</p>
                <h4>Conclusion</h4>
                <p>${research.conclusion}</p>
            `;
            
            document.getElementById('brief-source').textContent = `Source: ${research.source}`;
        }

        function displayConcepts(concepts) {
            const grid = document.getElementById('flashcard-grid');
            grid.innerHTML = '';
            
            concepts.forEach(concept => {
                const card = document.createElement('div');
                card.className = 'flashcard';
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-face card-front">
                            <h3>${concept.term}</h3>
                        </div>
                        <div class="card-face card-back">
                            <p>${concept.definition}</p>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => card.classList.toggle('is-flipped'));
                grid.appendChild(card);
            });
        }

        function showLoading() {
            document.getElementById('brief-title').textContent = 'Generating...';
            document.getElementById('research-paper-content').innerHTML = '<p class="loading">Creating your personalized research paper...</p>';
            document.getElementById('brief-source').textContent = '';
            document.getElementById('flashcard-grid').innerHTML = '<p class="loading">Preparing core concepts...</p>';
        }

        function showError(message) {
            const errorHtml = `<div class="error"><strong>Error:</strong> ${message}<br><small>Try refreshing the page or selecting a different date.</small></div>`;
            document.getElementById('research-paper-content').innerHTML = errorHtml;
            document.getElementById('flashcard-grid').innerHTML = '';
        }

        // LocalStorage caching functions
        function getFromCache(dateString) {
            const key = `innerlab_${dateString}`;
            const cached = localStorage.getItem(key);
            return cached ? JSON.parse(cached) : null;
        }

        function saveToCache(dateString, data) {
            const key = `innerlab_${dateString}`;
            localStorage.setItem(key, JSON.stringify(data));
        }

        // Journal functions
        function loadJournal(dateString) {
            const key = `journal_${dateString}`;
            const saved = localStorage.getItem(key);
            journalEntry.value = saved || '';
            updateJournalStatus(saved);
        }

        function saveJournal() {
            const key = `journal_${currentDate}`;
            const text = journalEntry.value;
            
            localStorage.setItem(key, text);
            
            journalStatus.textContent = 'âœ“ Saved locally';
            journalStatus.style.color = '#28a745';
            
            setTimeout(() => {
                journalStatus.textContent = '';
            }, 3000);
        }

        function updateJournalStatus(hasContent) {
            if (hasContent) {
                journalStatus.textContent = 'Previously saved entry loaded';
                journalStatus.style.color = '#666';
            } else {
                journalStatus.textContent = '';
            }
        }

        // Auto-save journal as user types (debounced)
        let saveTimeout;
        journalEntry.addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveJournal();
            }, 2000);
        });
    </script>
</body>
</html>
